<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libreta de Campo - QC</title>
    <link rel="stylesheet" href="styles.css" id="main-styles">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div class="container card soft">
        <!-- Header con logos y título -->
        <header class="main-header">
            <div class="logo-container">
                <img src="RAC-FOT.jpg" alt="Logo" class="logo">
            </div>
            <div class="header-content">
                <h1><i class="fas fa-book"></i> Libreta de Campo - QC-V9</h1>
                <p class="note">Registra y almacena tus observaciones de campo localmente</p>
                <div class="version-info note">
                    Versión: <span id="app-version"></span>
                    <span class="last-saved">Última actualización: <span id="last-saved"></span></span>
                </div>
            </div>
        </header>
        
        <!-- Navegación -->
        <nav class="main-nav">
            <button class="nav-btn active" data-tab="registro">
                <i class="fas fa-plus-circle"></i> Registrar
            </button>
            <button class="nav-btn" data-tab="observaciones">
                <i class="fas fa-list"></i> Observaciones
            </button>
            <button class="nav-btn" data-tab="mapa">
                <i class="fas fa-map-marked-alt"></i> Mapa
            </button>
            <button class="nav-btn" data-tab="configuracion">
                <i class="fas fa-cog"></i> Configuración
            </button>
        </nav>
        
        <!-- Contenido principal -->
        <main id="main-content">
            <!-- Sección de registro -->
            <section id="registro" class="tab-content active">
                <div class="form-section card">
                    <h2><i class="fas fa-clipboard-list"></i> Registrar Nueva Observación</h2>
                    <form id="observationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="date-time"><i class="far fa-calendar-alt"></i> Fecha y Hora:</label>
                                <input type="datetime-local" id="date-time" name="datetime" required readonly class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label for="location"><i class="fas fa-map-marker-alt"></i> Ubicación:</label>
                                <div class="location-input-container">
                                    <input type="text" id="location" name="location" required placeholder="Ingrese ubicación o use GPS" class="form-control">
                                    <button type="button" id="get-location-btn" class="btn btn-ghost" title="Obtener ubicación actual">
                                        <i class="fas fa-location-crosshairs"></i> GPS
                                    </button>
                                    <button type="button" id="place-pin-btn" class="btn btn-ghost" title="Colocar pin en el mapa">
                                        <i class="fas fa-map-marker-alt"></i> Pin
                                    </button>
                                </div>
                                <div id="location-display" class="location-display">
                                    <span id="coordinates"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-project-diagram"></i> Frente de Trabajo:</label>
                                <div class="dropdown-card sys-select" id="work-front-dropdown">
                                    <div class="dropdown-header" id="work-front-header">
                                        <span id="selected-work-front">Seleccione un frente</span>
                                        <span class="dropdown-arrow">▼</span>
                                    </div>
                                    <div class="dropdown-options" id="work-front-options">
                                        <div class="search-container">
                                            <input type="text" id="work-front-search" placeholder="Buscar frente de trabajo...">
                                        </div>
                                        <div class="dropdown-option" data-value="acceso_835">Acceso 835</div>
                                        <div class="dropdown-option" data-value="acceso_870">Acceso 870</div>
                                        <div class="dropdown-option" data-value="acceso_banda_y_p865">Acceso Banda y P865</div>
                                        <div class="dropdown-option" data-value="acceso_de_estabilizacion">Acceso de estabilización</div>
                                        <div class="dropdown-option" data-value="acceso_fbc5">Acceso FBC5</div>
                                        <div class="dropdown-option" data-value="acceso_p960_p980">Acceso P960 - P980</div>
                                        <div class="dropdown-option" data-value="acceso_p980_via_12">Acceso P980 - Via 12</div>
                                        <div class="dropdown-option" data-value="acceso_subpresa">Acceso SubPresa</div>
                                        <div class="dropdown-option" data-value="acceso_sur_c970">Acceso Sur C970</div>
                                        <div class="dropdown-option" data-value="bypass_via_del_condor">Baipás Vía del Cóndor</div>
                                        <div class="dropdown-option" data-value="berma_de_refuerzo_p830">Berma de refuerzo P830</div>
                                        <div class="dropdown-option" data-value="c980_ed_p895_sub1">C980-ED P895 (Subsecuencia 1)</div>
                                        <div class="dropdown-option" data-value="c980_ed_p920_sub1">C980-ED P920 (Subsecuencia 1)</div>
                                        <div class="dropdown-option" data-value="c980_ei_p890_sub1">C980-EI P890 (Subsecuencia 1)</div>
                                        <div class="dropdown-option" data-value="corona_960">Corona 960</div>
                                        <div class="dropdown-option" data-value="corona_970">Corona 970</div>
                                        <div class="dropdown-option" data-value="coronamiento_945">Coronamiento 945</div>
                                        <div class="dropdown-option" data-value="dren_28_a">Dren 28 A</div>
                                        <div class="dropdown-option" data-value="dren_980_a">Dren 980-A</div>
                                        <div class="dropdown-option" data-value="dren_980_b">Dren 980-B</div>
                                        <div class="dropdown-option" data-value="dren_acceso_p980">Dren Acceso P980</div>
                                        <div class="dropdown-option" data-value="dren_basal">Dren Basal</div>
                                        <div class="dropdown-option" data-value="dren_d_24">Dren D-24</div>
                                        <div class="dropdown-option" data-value="dren_d_25">Dren D-25</div>
                                        <div class="dropdown-option" data-value="dren_de_derivacion">Dren de Derivación</div>
                                        <div class="dropdown-option" data-value="dren_derivacion_01">Dren de Derivación D-01</div>
                                        <div class="dropdown-option" data-value="dren_derivacion_02">Dren de Derivación D-02</div>
                                        <div class="dropdown-option" data-value="dren_derivacion_03">Dren de Derivación D-03</div>
                                        <div class="dropdown-option" data-value="dren_derivacion_04">Dren de Derivación D-04</div>
                                        <div class="dropdown-option" data-value="dren_derivacion_05">Dren de Derivación D-05</div>
                                        <div class="dropdown-option" data-value="dren_derivacion_06">Dren de Derivación D-06</div>
                                        <div class="dropdown-option" data-value="dren_derivacion_vc">Dren de Derivación D-V.C.</div>
                                        <div class="dropdown-option" data-value="dren_derivacion_p980">Dren de derivación P980</div>
                                        <div class="dropdown-option" data-value="dren_derivacion_37">Dren Derivación 37</div>
                                        <div class="dropdown-option" data-value="dren_existente_p885">Dren existente P885</div>
                                        <div class="dropdown-option" data-value="dren_inclinado">Dren Inclinado</div>
                                        <div class="dropdown-option" data-value="dren_inclinado_p970_ei">Dren Inclinado P970 E.I.</div>
                                        <div class="dropdown-option" data-value="dren_inclinado_subpresa">Dren Inclinado Subpresa</div>
                                        <div class="dropdown-option" data-value="hombro_izquierdo">Hombro Izquierdo</div>
                                        <div class="dropdown-option" data-value="impermeabilizacion_c970">Impermeabilizacion C970</div>
                                        <div class="dropdown-option" data-value="p835">P835</div>
                                        <div class="dropdown-option" data-value="p845_estribo_izq">P845 Estribo Izq.</div>
                                        <div class="dropdown-option" data-value="p865_estribo_der">P865 Estribo der</div>
                                        <div class="dropdown-option" data-value="p865_estribo_izq_1">P865 Estribo Izq</div>
                                        <div class="dropdown-option" data-value="p865_estribo_izq_2">P865 Estribo Izq</div>
                                        <div class="dropdown-option" data-value="p870_acceso_fbc6">P870 (acceso a la FBC6)</div>
                                        <div class="dropdown-option" data-value="p885_estribo_der">P885 Estribo Der</div>
                                        <div class="dropdown-option" data-value="p885_estribo_izq">P885 Estribo Izq</div>
                                        <div class="dropdown-option" data-value="p895_c980_sub1">P895 (C980 Subsecuencia 1)</div>
                                        <div class="dropdown-option" data-value="p912_estribo_der">P912 Estribo Der.</div>
                                        <div class="dropdown-option" data-value="p912_estribo_izq">P912 Estribo Izq</div>
                                        <div class="dropdown-option" data-value="p920_c980_sub1">P920 (C980 Subsecuencia 1)</div>
                                        <div class="dropdown-option" data-value="p920_sub2">P920 (Subsecuencia 2)</div>
                                        <div class="dropdown-option" data-value="p945_sub5">P945 (Subsecuencia 5)</div>
                                        <div class="dropdown-option" data-value="p920_estribo_izquierdo">P920 Estribo Izquierdo</div>
                                        <div class="dropdown-option" data-value="p960_acceso_fbc5">P960 Acceso FBC5</div>
                                        <div class="dropdown-option" data-value="p960_estribo_der">P960 Estribo Der</div>
                                        <div class="dropdown-option" data-value="p960_estribo_izq">P960 Estribo Izq</div>
                                        <div class="dropdown-option" data-value="p970_sub3">P970 (Subsecuencia 3)</div>
                                        <div class="dropdown-option" data-value="p980">P980</div>
                                        <div class="dropdown-option" data-value="plataforma_890">Plataforma 890</div>
                                        <div class="dropdown-option" data-value="plataforma_895">Plataforma 895</div>
                                        <div class="dropdown-option" data-value="plataforma_920">Plataforma 920</div>
                                        <div class="dropdown-option" data-value="plataforma_945">Plataforma 945</div>
                                        <div class="dropdown-option" data-value="plataforma_980">Plataforma 980</div>
                                        <div class="dropdown-option" data-value="plataforma_dren_basal">Plataforma Dren Basal</div>
                                        <div class="dropdown-option" data-value="plataforma_p830">Plataforma P830</div>
                                        <div class="dropdown-option" data-value="plataforma_p845">Plataforma P845</div>
                                        <div class="dropdown-option" data-value="plataforma_p860">Plataforma P860</div>
                                        <div class="dropdown-option" data-value="plataforma_p865">Plataforma P865</div>
                                        <div class="dropdown-option" data-value="plataforma_p870">Plataforma P870</div>
                                        <div class="dropdown-option" data-value="plataforma_p875">Plataforma P875</div>
                                        <div class="dropdown-option" data-value="plataforma_p885">Plataforma P885</div>
                                        <div class="dropdown-option" data-value="plataforma_p895_2">Plataforma P895</div>
                                        <div class="dropdown-option" data-value="plataforma_p912">Plataforma P912</div>
                                        <div class="dropdown-option" data-value="plataforma_p960">Plataforma P960</div>
                                        <div class="dropdown-option" data-value="plataforma_p970_ei">Plataforma P970 E.I.</div>
                                        <div class="dropdown-option" data-value="plataforma_p980_ei">Plataforma P980 E.I.</div>
                                        <div class="dropdown-option" data-value="subdren">Subdren</div>
                                        <div class="dropdown-option" data-value="subpresa_c970">Subpresa C970</div>
                                        <div class="dropdown-option" data-value="talud_margen_izquierdo">Talud Margen Izquierdo</div>
                                        <div class="dropdown-option" data-value="tapete_drenante">Tapete Drenante</div>
                                        <div class="dropdown-option" data-value="tapete_drenante_tipo_a">Tapete Drenante Tipo A estr. der.</div>
                                        <div class="dropdown-option" data-value="tapete_drenante_tipo_b">Tapete Drenante Tipo B estr. izq.</div>
                                        <div class="dropdown-option" data-value="tapete_subpresa">Tapete Subpresa</div>
                                        <div class="dropdown-option" data-value="via_al_condor">Via al condor</div>
                                        <div class="dropdown-option" data-value="via_alterna_fbc_5">Vía Alterna FBC 5</div>
                                        <div class="dropdown-option" data-value="c980_ed_p920_sub2">C980-ED P920 (Subsecuencia 2)</div>
                                        <div class="dropdown-option" data-value="c980_ei_p920_sub2">C980-EI P920 (Subsecuencia 2)</div>
                                        <div class="dropdown-option" data-value="c980_ei_p950_sub2">C980-EI P950 (Subsecuencia 2)</div>
                                        <div class="dropdown-option" data-value="c980_ed_p965_sub2">C980-ED P965 (Subsecuencia 2)</div>
                                        <div class="dropdown-option" data-value="p920_cuerpo_principal_sub2">P920 Cuerpo principal (C980 Subsec 2)</div>
                                        <div class="dropdown-option" data-value="p965_cuerpo_principal_sub2">P965 Cuerpo principal (C980 Subsec 2)</div>
                                        <div class="dropdown-option" data-value="p896_cuerpo_principal_sub2">P896 Cuerpo principal (C980 Subsec 2)</div>
                                        <div class="dropdown-option" data-value="otros">Otros</div>
                                    </div>
                                    <input type="hidden" id="work-front" name="workfront" required>
                                </div>
                                <div id="otros-input-group" style="display: none; margin-top: 10px;">
                                    <label for="otros-input"><i class="fas fa-edit"></i> Ingrese el nombre del frente:</label>
                                    <input type="text" id="otros-input" class="form-control" placeholder="Ingrese nombre del frente de trabajo">
                                </div>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-crown"></i> Coronamiento:</label>
                                <div class="dropdown-card sys-select" id="coronamiento-dropdown">
                                    <div class="dropdown-header" id="coronamiento-header">
                                        <span id="selected-coronamiento">Seleccione un coronamiento</span>
                                        <span class="dropdown-arrow">▼</span>
                                    </div>
                                    <div class="dropdown-options" id="coronamiento-options">
                                        <div class="dropdown-option" data-value="c970">C970</div>
                                        <div class="dropdown-option" data-value="c980">C980</div>
                                        <div class="dropdown-option" data-value="c960">C960</div>
                                        <div class="dropdown-option" data-value="ninguno">Ninguno</div>
                                    </div>
                                    <input type="hidden" id="coronamiento" name="coronamiento" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-tags"></i> Tipo de Observación:</label>
                                <div class="dropdown-card sys-select" id="tag-dropdown">
                                    <div class="dropdown-header" id="tag-header">
                                        <span id="selected-tag">Seleccione un tipo</span>
                                        <span class="dropdown-arrow">▼</span>
                                    </div>
                                    <div class="dropdown-options" id="tag-options">
                                        <div class="dropdown-option tag-option" data-value="rutina">
                                            <span class="tag-color" style="background-color: #3498db;"></span>
                                            <i class="fas fa-check-circle"></i> Rutina
                                        </div>
                                        <div class="dropdown-option tag-option" data-value="novedad">
                                            <span class="tag-color" style="background-color: #f1c40f;"></span>
                                            <i class="fas fa-exclamation-circle"></i> Novedad
                                        </div>
                                        <div class="dropdown-option tag-option" data-value="importante">
                                            <span class="tag-color" style="background-color: #e74c3c;"></span>
                                            <i class="fas fa-exclamation-triangle"></i> Importante
                                        </div>
                                    </div>
                                    <input type="hidden" id="tag" name="tag" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" id="additional-info-group" style="display: none;">
                            <label for="additional-info"><i class="fas fa-info-circle"></i> Información Adicional (Drenes y Plataforma):</label>
                            <textarea id="additional-info" name="additionalinfo" rows="3" class="form-control" placeholder="Ingrese información adicional para drenes y plataforma"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes"><i class="fas fa-sticky-note"></i> Actividades Realizadas:</label>
                            <textarea id="notes" name="notes" rows="4" class="form-control" placeholder="Descripción detallada de las actividades realizadas"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="photo"><i class="fas fa-camera"></i> Fotos (opcional):</label>
                            <div class="photo-upload-container">
                                <input type="file" id="photo" name="photo" accept="image/*" multiple capture="environment" class="form-control">
                                <div id="photo-preview" class="photo-preview"></div>
                                <button type="button" id="add-more-photos" class="btn btn-secondary" style="margin-top: 10px; display: none;">
                                    <i class="fas fa-camera"></i> Añadir más fotos
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Observación
                            </button>
                            <button type="button" id="clear-form-btn" class="btn btn-ghost">
                                <i class="fas fa-eraser"></i> Limpiar Formulario
                            </button>
                        </div>
                    </form>
                </div>
            </section>
            
            <!-- Sección de observaciones -->
            <section id="observaciones" class="tab-content">
                <div class="data-section card">
                    <h2><i class="fas fa-clipboard-list"></i> Observaciones Guardadas</h2>
                    <div class="controls">
                        <button id="exportBtn" class="btn btn-primary">
                            <i class="fas fa-file-export"></i> Exportar Datos
                        </button>
                        <button id="clearBtn" class="btn btn-danger">
                            <i class="fas fa-trash-alt"></i> Limpiar Todos los Datos
                        </button>
                    </div>
                    <div id="observationsList" class="grid-2"></div>
                </div>
            </section>
            
            <!-- Sección de mapa -->
            <section id="mapa" class="tab-content">
                <div class="map-section card">
                    <h2><i class="fas fa-map-marked-alt"></i> Mapa de Observaciones</h2>
                    <div class="map-container">
                        <div id="map" class="map-view">
                            <img id="map-image" src="RAC-FOT.jpg" alt="Mapa RAC-FOT" class="map-image">
                            <div id="map-overlay" class="map-overlay"></div>
                        </div>
                        <div class="map-controls">
                            <button id="zoom-in" class="btn btn-ghost"><i class="fas fa-search-plus"></i> Acercar</button>
                            <button id="zoom-out" class="btn btn-ghost"><i class="fas fa-search-minus"></i> Alejar</button>
                            <button id="reset-view" class="btn btn-ghost"><i class="fas fa-sync-alt"></i> Reiniciar</button>
                        </div>
                        <div class="map-info">
                            <div class="legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                                    <span>Importante</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #f1c40f;"></div>
                                    <span>Novedad</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #3498db;"></div>
                                    <span>Rutina</span>
                                </div>
                            </div>
                            <div id="map-coordinates" class="map-coordinates">Coordenadas: --</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Sección de configuración -->
            <section id="configuracion" class="tab-content">
                <div class="config-section card">
                    <h2><i class="fas fa-cog"></i> Configuración</h2>
                    <div class="config-options">
                        <div class="config-item">
                            <label for="theme-selector"><i class="fas fa-palette"></i> Tema Visual</label>
                            <select id="theme-selector" class="form-control">
                                <option value="dark">Oscuro (Predeterminado)</option>
                                <option value="light">Claro</option>
                                <option value="blue">Azul Profundo</option>
                            </select>
                        </div>
                        
                        <div class="config-item">
                            <label for="auto-save"><i class="fas fa-save"></i> Guardado Automático</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="auto-save" checked>
                                <label for="auto-save">Activado</label>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <label for="notifications"><i class="fas fa-bell"></i> Notificaciones</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="notifications" checked>
                                <label for="notifications">Activadas</label>
                            </div>
                        </div>
                        
                        <div class="config-item">
                            <button id="backup-btn" class="btn btn-primary">
                                <i class="fas fa-cloud-upload-alt"></i> Crear Copia de Seguridad
                            </button>
                        </div>
                        
                        <div class="config-item">
                            <button id="restore-btn" class="btn btn-ghost">
                                <i class="fas fa-cloud-download-alt"></i> Restaurar Copia de Seguridad
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- Modal para mensajes -->
        <div id="message-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Mensaje</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="modal-message">Contenido del mensaje</p>
                </div>
                <div class="modal-footer">
                    <button id="modal-ok" class="btn btn-primary">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script src="jszip.min.js"></script>
    <script src="script.js" id="main-script"></script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>

    <!-- Modal para el mapa -->
    <div id="map-modal" class="modal">
        <div class="modal-content" style="max-width: 90vw; height: 90vh;">
            <div class="modal-header">
                <h3>Seleccionar Ubicación en el Mapa</h3>
                <span class="close" id="close-map-modal">&times;</span>
            </div>
            <div class="modal-body" style="height: calc(100% - 120px); padding: 0;">
                <div id="modal-map-container" style="width: 100%; height: 100%; position: relative; overflow: auto;">
                    <img src="RAC-FOT.jpg" alt="Mapa para seleccionar ubicación" id="modal-map-image" style="width: 100%; height: auto; cursor: crosshair;">
                    <div id="modal-map-pin" style="position: absolute; display: none; transform: translate(-50%, -100%);">
                        <i class="fas fa-map-marker-alt" style="color: red; font-size: 2rem;"></i>
                    </div>
                    <div class="map-controls modal-map-controls">
                        <button type="button" id="modal-zoom-in" class="btn btn-ghost"><i class="fas fa-search-plus"></i></button>
                        <button type="button" id="modal-zoom-out" class="btn btn-ghost"><i class="fas fa-search-minus"></i></button>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <span id="modal-coordinates-display" style="text-align: left; font-size: 0.9rem;">Seleccione un punto en el mapa...</span>
                <button id="confirm-location-btn" class="btn btn-primary" disabled>Confirmar Ubicación</button>
            </div>
        </div>
    </div>
</body>
</html>